name: Update Packages

on:
  schedule:
    - cron: '0 18 * * *'
  workflow_dispatch:

permissions:
  contents: write

env:
  GIT_AUTHOR_NAME: "github-actions[bot]"
  GIT_AUTHOR_EMAIL: "github-actions[bot]@users.noreply.github.com"
  BUILDER_USER: "aurbuilder"

jobs:
  update:
    name: Update AUR Packages
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest

    steps:
      - name: Install system dependencies
        run: |
          pacman -Syy --noconfirm --needed
          pacman -S --noconfirm --needed base-devel git uv sudo

      - name: Create builder user and setup environment
        run: |
          # Create non-root user for makepkg (makepkg refuses to run as root)
          useradd -m "${{ env.BUILDER_USER }}"
          echo "${{ env.BUILDER_USER }} ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

          # Configure git for builder user
          sudo -u "${{ env.BUILDER_USER }}" git config --global user.name "${{ env.GIT_AUTHOR_NAME }}"
          sudo -u "${{ env.BUILDER_USER }}" git config --global user.email "${{ env.GIT_AUTHOR_EMAIL }}"
          sudo -u "${{ env.BUILDER_USER }}" git config --global --add safe.directory "*"

      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Fix repository permissions
        run: |
          # Change ownership to builder user
          chown -R "${{ env.BUILDER_USER }}:${{ env.BUILDER_USER }}" "${GITHUB_WORKSPACE}"

      - name: Set up uv cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            scripts/.venv
          key: ${{ runner.os }}-uv-${{ hashFiles('scripts/pyproject.toml', 'scripts/uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-uv-

      - name: Install dependencies and update packages
        working-directory: scripts
        shell: bash
        run: |
          sudo -u "${{ env.BUILDER_USER }}" bash << 'EOF'
          echo "::group::Sync dependencies"
          uv sync
          echo "::endgroup::"

          echo "::group::Update packages"
          uv run main.py --all
          echo "::endgroup::"
          EOF

      - name: Check for changes
        id: check_changes
        shell: bash
        run: |
          UPDATED_PACKAGES=()
          HAS_CHANGES=false

          for pkg_path in packages/*; do
            [ -d "$pkg_path" ] || continue
            pkg_name=$(basename "$pkg_path")

            if ! git diff --quiet "$pkg_path/PKGBUILD" 2>/dev/null; then
              UPDATED_PACKAGES+=("$pkg_name")
              HAS_CHANGES=true
            fi
          done

          if [ "$HAS_CHANGES" = true ]; then
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            echo "updated_count=${#UPDATED_PACKAGES[@]}" >> "$GITHUB_OUTPUT"
          else
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            echo "updated_count=0" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit changes
        if: steps.check_changes.outputs.has_changes == 'true'
        shell: bash
        run: |
          sudo -u "${{ env.BUILDER_USER }}" bash << 'EOF'
          echo "::group::Stage PKGBUILD files"
          for pkg_path in packages/*; do
            [ -d "$pkg_path" ] || continue
            pkg_name=$(basename "$pkg_path")

            # Skip if PKGBUILD does not exist
            [ -f "$pkg_path/PKGBUILD" ] || continue

            # Add PKGBUILD
            git add "$pkg_path/PKGBUILD"

            # Generate and add .SRCINFO for AUR
            echo "::notice::Generating .SRCINFO for $pkg_name"
            (cd "$pkg_path" && makepkg --printsrcinfo > .SRCINFO)
            git add "$pkg_path/.SRCINFO"
          done
          echo "::endgroup::"

          # Show what will be committed
          echo "::group::Staged changes"
          git diff --cached --stat
          echo "::endgroup::"

          # Commit and push
          updated_count="${{ steps.check_changes.outputs.updated_count }}"
          git commit -m "chore: update AUR packages" \
                     -m "Updated ${updated_count} package(s)" \
                     -m "Co-Authored-By: github-actions[bot] <github-actions[bot]@users.noreply.github.com>"

          git push origin main
          EOF
