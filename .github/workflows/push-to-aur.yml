name: Push to AUR

on:
  workflow_run:
    workflows: [Update Packages]
    types: [completed]
    branches: [main]
  workflow_dispatch:
    inputs:
      packages:
        description: 'è¦æ¨é€çš„åŒ…åï¼ˆç•™ç©ºæ¨é€æ‰€æœ‰åŒ…ï¼Œé€—å·åˆ†éš”ï¼‰'
        required: false
        default: ''

permissions:
  contents: read

env:
  AUR_USERNAME: "github-actions[bot]"
  AUR_EMAIL: "github-actions[bot]@users.noreply.github.com"

jobs:
  setup:
    name: Setup matrix
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') ||
      github.event_name == 'workflow_dispatch'

    outputs:
      packages: ${{ steps.set_matrix.outputs.packages }}
      count: ${{ steps.set_matrix.outputs.count }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set matrix
        id: set_matrix
        run: |
          if [ -n "${{ github.event.inputs.packages }}" ]; then
            # ç”¨æˆ·æŒ‡å®šäº†åŒ…åˆ—è¡¨ï¼Œè½¬æ¢ä¸º JSON æ•°ç»„
            packages=$(echo "${{ github.event.inputs.packages }}" | tr ',' '\n' | jq -R . | jq -s -c .)
          else
            # è·å–æ‰€æœ‰åŒ…ç›®å½•ï¼Œè½¬æ¢ä¸º JSON æ•°ç»„
            packages=$(ls -d packages/*/ | xargs -n1 basename | jq -R . | jq -s -c .)
          fi

          echo "packages=$packages" >> "$GITHUB_OUTPUT"
          echo "count=$(echo "$packages" | jq 'length')" >> "$GITHUB_OUTPUT"

          echo "ğŸ“¦ å°†æ¨é€ä»¥ä¸‹åŒ…:"
          echo "$packages" | jq -r '.[]' | sed 's/^/   - /'

  push-to-aur:
    name: Push ${{ matrix.package }}
    runs-on: ubuntu-latest
    needs: setup

    strategy:
      matrix:
        package: ${{ fromJson(needs.setup.outputs.packages) }}
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Publish ${{ matrix.package }} to AUR
        uses: KSXGitHub/github-actions-deploy-aur@v2.7.0
        with:
          pkgname: ${{ matrix.package }}
          pkgbuild: packages/${{ matrix.package }}/PKGBUILD
          commit_username: ${{ env.AUR_USERNAME }}
          commit_email: ${{ env.AUR_EMAIL }}
          ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          commit_message: Automatic update from GitHub Actions
          ssh_keyscan_types: rsa,ecdsa,ed25519
