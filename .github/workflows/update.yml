name: Update AUR Packages
on:
  schedule:
    - cron: '0 18 * * *'
  workflow_dispatch:
jobs:
  update:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    defaults:
      run:
        # é»˜è®¤å·¥ä½œç›®å½•è®¾ä¸ºä»“åº“æ ¹ï¼ˆç”¨äºæ„å»ºæ­¥éª¤ï¼‰
        working-directory: ${{ github.workspace }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # å®‰è£…å¿…è¦å·¥å…·
      - name: Setup system packages
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm base-devel git openssh sudo curl

      # ä½¿ç”¨å®˜æ–¹ action å®‰è£… uv + Python 3.13ï¼ˆè‡ªåŠ¨æ·»åŠ  PATHï¼Œæ— éœ€æ‰‹åŠ¨ exportï¼‰
      - name: Setup uv & Python 3.13
        uses: astral-sh/setup-uv@v7
        with:
          python-version: '3.13'
          enable-cache: true  # å¯ç”¨ uv ç¼“å­˜ï¼ŒåŠ é€Ÿä¾èµ–å®‰è£…

      # ä½¿ç”¨ uv å®‰è£… Python ä¾èµ–ï¼ˆåˆ‡æ¢åˆ° scripts ç›®å½•ï¼‰
      - name: Setup Python dependencies
        working-directory: scripts  # å…³é”®ä¿®å¤ï¼šæŒ‡å®šé¡¹ç›®ç›®å½•
        run: |
          if [ -f "pyproject.toml" ]; then
            echo "Found pyproject.toml, syncing dependencies..."
            ls -la  # è°ƒè¯•ï¼šåˆ—å‡º scripts ç›®å½•æ–‡ä»¶
            uv sync
          else
            echo "Error: pyproject.toml not found in scripts/!"
            echo "Available files in scripts/:"
            ls -la
            echo "This workflow requires pyproject.toml in scripts/ for Python dependency management."
            exit 1
          fi

      # è¿è¡Œæ›´æ–°è„šæœ¬ï¼ˆä¹Ÿåœ¨ scripts ç›®å½•ï¼Œç¡®ä¿ main.py æ­£ç¡®æ‰§è¡Œï¼‰
      - name: Run main update script
        working-directory: scripts  # å…³é”®ä¿®å¤ï¼šç»Ÿä¸€ç›®å½•
        run: |
          uv run main.py

      # åˆ›å»ºé root æ„å»ºç”¨æˆ·
      - name: Create build user
        run: |
          useradd -m builduser
          echo "builduser ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/builduser
          passwd -d builduser

      # SSH é…ç½®ç”¨äº push AUR
      - name: Setup SSH for AUR
        run: |
          sudo -u builduser mkdir -p /home/builduser/.ssh
          echo "${{ secrets.AUR_SSH_PRIVATE_KEY }}" | sudo -u builduser tee /home/builduser/.ssh/id_ed25519 >/dev/null
          sudo -u builduser chmod 600 /home/builduser/.ssh/id_ed25519
          sudo -u builduser ssh-keyscan aur.archlinux.org >> /home/builduser/.ssh/known_hosts

      # builduser æ„å»ºç›®å½•æƒé™
      - name: Configure makepkg for builduser
        run: |
          cp /etc/makepkg.conf /home/builduser/makepkg.conf
          sed -i 's|^#*\s*BUILDDIR=.*|BUILDDIR=/home/builduser/build|' /home/builduser/makepkg.conf
          sed -i 's|^#*\s*PKGDEST=.*|PKGDEST=/home/builduser/pkgdest|' /home/builduser/makepkg.conf
          sed -i 's|^#*\s*SRCDEST=.*|SRCDEST=/home/builduser/srcdest|' /home/builduser/makepkg.conf
          mkdir -p /home/builduser/build /home/builduser/pkgdest /home/builduser/srcdest
          chown -R builduser:builduser /home/builduser

      # æ„å»º + æ¨é€æ‰€æœ‰åŒ…ï¼ˆåœ¨æ ¹ç›®å½•å¾ªç¯ packages/*ï¼Œmain.py æ›´æ–°åè¿™é‡Œæ„å»ºï¼‰
      - name: Build & Push AUR packages
        run: |
          set -e
          export MAKEPKG_CONF=/home/builduser/makepkg.conf
          for pkg in packages/*; do
            if [ -f "$pkg/PKGBUILD" ]; then
              echo "=== Processing: $pkg ==="
              pkgname=$(basename "$pkg")
              aur_repo="ssh://aur@aur.archlinux.org/${pkgname}.git"
              cd "$pkg"
              echo "ç”Ÿæˆ .SRCINFO..."
              sudo -u builduser MAKEPKG_CONF=$MAKEPKG_CONF makepkg --printsrcinfo > .SRCINFO
              echo "æ„å»ºæµ‹è¯• $pkgname ..."
              sudo -u builduser MAKEPKG_CONF=$MAKEPKG_CONF makepkg -fs --noconfirm
              cd ../../
              # å…‹éš† AUR ä»“åº“
              sudo -u builduser git clone "$aur_repo" "/home/builduser/aur-$pkgname"
              # å¤åˆ¶æ‰€æœ‰æ–‡ä»¶ï¼ˆåŒ…å«éšè—æ–‡ä»¶ï¼‰
              sudo -u builduser cp -a "$pkg"/. "/home/builduser/aur-$pkgname/"
              cd "/home/builduser/aur-$pkgname"
              sudo -u builduser git config user.email "github-actions@github.com"
              sudo -u builduser git config user.name "GitHub Actions"
              sudo -u builduser git add -A
              sudo -u builduser git commit -m "Update: $(date -u +"%Y-%m-%d")" || echo "No changes"
              sudo -u builduser git push || echo "Nothing to push"
              cd -
            fi
          done

      # æäº¤ packages æ–‡ä»¶å¤¹çš„æ›´æ–°åˆ°æœ¬ä»“åº“
      - name: Commit PKGBUILD updates to repository
        run: |
          # é…ç½® Git
          git config user.name "GitHub Actions"
          git config user.email "github-actions@github.com"

          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --quiet packages/; then
            echo "âœ… packages/ ç›®å½•æ— å˜æ›´ï¼Œè·³è¿‡æäº¤"
          else
            echo "ğŸ“¦ æ£€æµ‹åˆ° packages/ ç›®å½•æœ‰å˜æ›´ï¼Œå‡†å¤‡æäº¤..."

            # æ·»åŠ æ‰€æœ‰ packages ç›®å½•çš„å˜æ›´
            git add packages/

            # ç”Ÿæˆæäº¤ä¿¡æ¯
            COMMIT_MSG="chore(packages): :package: è‡ªåŠ¨æ›´æ–° PKGBUILD æ–‡ä»¶\n\n"
            COMMIT_MSG+="æ›´æ–°æ—¶é—´: $(date -u +"%Y-%m-%d %H:%M:%S UTC")\n\n"
            COMMIT_MSG+="å·²æ›´æ–°çš„åŒ…:\n"

            # åˆ—å‡ºæ‰€æœ‰æ›´æ–°çš„åŒ…
            for pkg in packages/*/; do
              if [ -f "$pkg/PKGBUILD" ]; then
                pkgname=$(basename "$pkg")
                if git diff --cached --quiet "$pkg" --; then
                  # è¿™ä¸ªåŒ…æ²¡æœ‰å˜æ›´ï¼Œè·³è¿‡
                  :
                else
                  # è¿™ä¸ªåŒ…æœ‰å˜æ›´
                  version=$(grep "^pkgver=" "$pkg/PKGBUILD" | cut -d= -f2)
                  pkgrel=$(grep "^pkgrel=" "$pkg/PKGBUILD" | cut -d= -f2)
                  COMMIT_MSG+="- ${pkgname} (ç‰ˆæœ¬: ${version}, å‘å¸ƒ: ${pkgrel})\n"
                fi
              fi
            done

            # æäº¤å˜æ›´
            echo -e "$COMMIT_MSG" | git commit -F -

            # æ¨é€å˜æ›´
            echo "ğŸš€ æ¨é€å˜æ›´åˆ°ä»“åº“..."
            git push

            echo "âœ… å˜æ›´å·²æˆåŠŸæäº¤å¹¶æ¨é€"
          fi