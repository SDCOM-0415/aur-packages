name: Update AUR Packages

on:
  schedule:
    - cron: '0 18 * * *'  # æ¯å¤©åŒ—äº¬æ—¶é—´ 02:00 (UTC 18:00) è¿è¡Œ
  workflow_dispatch:

permissions:
  contents: write

env:
  GIT_AUTHOR_NAME: "github-actions[bot]"
  GIT_AUTHOR_EMAIL: "github-actions[bot]@users.noreply.github.com"
  GIT_COMMITTER_NAME: "github-actions[bot]"
  GIT_COMMITTER_EMAIL: "github-actions[bot]@users.noreply.github.com"

jobs:
  update:
    name: Update and Push AUR Packages
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest

    steps:
      # ============================================================
      # é˜¶æ®µ 0: ç¯å¢ƒå‡†å¤‡
      # ============================================================

      - name: Install system dependencies
        run: |
          pacman -Syu --noconfirm --needed
          pacman -S --noconfirm --needed base-devel git openssh curl python python-pip

      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git safe directory
        run: |
          git config --global --add safe.directory /__w/aur-packages/aur-packages
          git config --global user.name "${{ env.GIT_AUTHOR_NAME }}"
          git config --global user.email "${{ env.GIT_AUTHOR_EMAIL }}"
          git config --global push.default simple

      - name: Initialize submodules
        run: |
          git submodule update --init --recursive

      # ============================================================
      # é˜¶æ®µ 1: è¿è¡Œæ›´æ–° AUR åŒ…è„šæœ¬
      # ============================================================

      - name: Setup Python environment
        uses: astral-sh/setup-uv@v7
        with:
          python-version: '3.13'
          enable-cache: true
          cache-dependency-glob: 'scripts/pyproject.toml'

      - name: Install Python dependencies
        working-directory: scripts
        run: uv sync

      - name: Update AUR packages
        id: update_packages
        working-directory: scripts
        run: uv run main.py --all

      # ============================================================
      # é˜¶æ®µ 2: é…ç½® AUR SSH è®¿é—®
      # ============================================================

      - name: Configure SSH for AUR
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.AUR_SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan aur.archlinux.org >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts
          git config --global url."ssh://git@aur.archlinux.org/".insteadOf "https://aur.archlinux.org/"

      - name: Verify SSH connection
        run: |
          ssh -o StrictHostKeyChecking=no aur@aur.archlinux.org info

      # ============================================================
      # é˜¶æ®µ 3: åœ¨ AUR å­æ¨¡å—ä¸­æ¨é€åŒ…
      # ============================================================

      - name: Setup build user
        run: |
          useradd -m -G wheel builduser
          echo "builduser ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/builduser

      - name: Build and push to AUR submodules
        id: build_aur
        shell: bash
        run: |
          set -eo pipefail

          UPDATED_PACKAGES=()
          FAILED_PACKAGES=()
          MAIN_DIR=$(pwd)

          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "é˜¶æ®µ 3: æ„å»º AUR åŒ…å¹¶æ¨é€åˆ° AUR ä»“åº“"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          for pkg_path in packages/*; do
            # è·³è¿‡éç›®å½•
            [ -d "$pkg_path" ] || continue

            pkg_name=$(basename "$pkg_path")
            echo ""
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            echo "å¤„ç†åŒ…: $pkg_name"
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

            # è¿›å…¥å­æ¨¡å—ç›®å½•
            cd "$pkg_path" || {
              echo "âŒ æ— æ³•è¿›å…¥ç›®å½•: $pkg_path"
              FAILED_PACKAGES+=("$pkg_name:cd_failed")
              cd "$MAIN_DIR"
              continue
            }

            # éªŒè¯æ˜¯å¦ä¸º git ä»“åº“
            if ! git rev-parse --git-dir > /dev/null 2>&1; then
              echo "â­ï¸  ä¸æ˜¯ git ä»“åº“ï¼Œè·³è¿‡"
              cd "$MAIN_DIR"
              continue
            fi

            # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ–°
            if git diff --quiet PKGBUILD && git diff --cached --quiet PKGBUILD; then
              echo "â„¹ï¸  PKGBUILD æ— å˜åŒ–ï¼Œè·³è¿‡"
              cd "$MAIN_DIR"
              continue
            fi

            echo "ğŸ“ æ£€æµ‹åˆ° PKGBUILD æ›´æ–°"

            # æ˜¾ç¤ºå˜æ›´
            git diff PKGBUILD || true

            # æ›´æ”¹æ–‡ä»¶æ‰€æœ‰è€…
            chown -R builduser:builduser "$(pwd)"

            # ç”Ÿæˆ .SRCINFO
            echo "ğŸ”¨ ç”Ÿæˆ .SRCINFO..."
            if ! sudo -u builduser makepkg --printsrcinfo > .SRCINFO; then
              echo "âŒ ç”Ÿæˆ .SRCINFO å¤±è´¥"
              FAILED_PACKAGES+=("$pkg_name:srcinfo_failed")
              cd "$MAIN_DIR"
              continue
            fi

            # éªŒè¯ PKGBUILD
            echo "ğŸ” éªŒè¯ PKGBUILD..."
            if ! sudo -u builduser makepkg -f --noconfirm --noprepare --nobuild; then
              echo "âŒ PKGBUILD éªŒè¯å¤±è´¥"
              FAILED_PACKAGES+=("$pkg_name:validation_failed")
              cd "$MAIN_DIR"
              continue
            fi

            # æå–ç‰ˆæœ¬ä¿¡æ¯
            pkgver=$(grep '^pkgver=' PKGBUILD | cut -d= -f2 | tr -d '"' | tr -d "'")
            pkgrel=$(grep '^pkgrel=' PKGBUILD | cut -d= -f2 | tr -d '"' | tr -d "'")

            if [ -z "$pkgver" ]; then
              echo "âŒ æ— æ³•æå– pkgver"
              FAILED_PACKAGES+=("$pkg_name:no_pkgver")
              cd "$MAIN_DIR"
              continue
            fi

            echo "ğŸ“¦ ç‰ˆæœ¬: $pkgver-$pkgrel"

            # æäº¤æ›´æ”¹
            git add PKGBUILD .SRCINFO

            if git diff --cached --quiet; then
              echo "â„¹ï¸  æš‚å­˜åŒºæ— å˜åŒ–ï¼Œè·³è¿‡æäº¤"
              cd "$MAIN_DIR"
              continue
            fi

            commit_msg="Update to $pkgver-$pkgrel"
            if ! git commit -m "$commit_msg"; then
              echo "âŒ Git æäº¤å¤±è´¥"
              FAILED_PACKAGES+=("$pkg_name:commit_failed")
              cd "$MAIN_DIR"
              continue
            fi

            echo "ğŸ“¤ æ¨é€åˆ° AUR..."
            # æ¨é€åˆ° AURï¼Œå¦‚æœå¤±è´¥åˆ™å›æ»šæäº¤
            if git push; then
              echo "âœ… æ¨é€æˆåŠŸ: $pkg_name $pkgver-$pkgrel"
              UPDATED_PACKAGES+=("$pkg_name:$pkgver-$pkgrel")
            else
              echo "âŒ æ¨é€å¤±è´¥"
              FAILED_PACKAGES+=("$pkg_name:push_failed")
              git reset --soft HEAD~1
            fi

            cd "$MAIN_DIR"
          done

          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "AUR æ¨é€å®Œæˆ"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          # è¾“å‡ºç»“æœåˆ° GitHub Actions
          echo "updated_count=${#UPDATED_PACKAGES[@]}" >> $GITHUB_OUTPUT
          echo "failed_count=${#FAILED_PACKAGES[@]}" >> $GITHUB_OUTPUT

          if [ ${#UPDATED_PACKAGES[@]} -gt 0 ]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
          fi

          # è¾“å‡ºæ›´æ–°çš„åŒ…åˆ—è¡¨
          if [ ${#UPDATED_PACKAGES[@]} -gt 0 ]; then
            echo ""
            echo "âœ… æˆåŠŸæ›´æ–°çš„åŒ…:"
            for pkg in "${UPDATED_PACKAGES[@]}"; do
              echo "   - $pkg"
            done
          fi

          # è¾“å‡ºå¤±è´¥çš„åŒ…åˆ—è¡¨
          if [ ${#FAILED_PACKAGES[@]} -gt 0 ]; then
            echo ""
            echo "âŒ å¤±è´¥çš„åŒ…:"
            for pkg in "${FAILED_PACKAGES[@]}"; do
              echo "   - $pkg"
            done
          fi

      # ============================================================
      # é˜¶æ®µ 4: åŒæ­¥ä¸»ä»“åº“å­æ¨¡å—å¼•ç”¨
      # ============================================================

      - name: Sync main repository submodules
        if: steps.build_aur.outputs.has_updates == 'true'
        run: |
          set -eo pipefail

          cd /__w/aur-packages/aur-packages

          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "é˜¶æ®µ 4: åŒæ­¥ä¸»ä»“åº“å­æ¨¡å—å¼•ç”¨"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          echo ""
          echo "ğŸ“Š å­æ¨¡å—å˜æ›´æ‘˜è¦:"
          git submodule summary

          echo ""
          echo "ğŸ”„ æ·»åŠ å­æ¨¡å—å˜æ›´..."

          has_changes=false
          for submodule in packages/*; do
            if [ -d "$submodule" ] && [ -d "$submodule/.git" ]; then
              echo "  - $(basename "$submodule")"
              git add "$submodule"
              has_changes=true
            fi
          done

          if [ "$has_changes" = false ]; then
            echo "â„¹ï¸  æ— å­æ¨¡å—å˜æ›´éœ€è¦æäº¤"
            exit 0
          fi

          # æ£€æŸ¥æ˜¯å¦æœ‰æš‚å­˜çš„æ›´æ”¹
          if git diff --cached --quiet; then
            echo "â„¹ï¸  æš‚å­˜åŒºæ— å˜åŒ–"
            exit 0
          fi

          echo ""
          echo "ğŸ“ æäº¤å­æ¨¡å—å¼•ç”¨æ›´æ–°..."

          updated_count="${{ steps.build_aur.outputs.updated_count }}"
          commit_msg=$'chore: ğŸ”¨ sync AUR submodule references\n\nSync submodule pointers with AUR repositories.\n\nUpdated '"${updated_count}"$' packages\n\nCo-Authored-By: github-actions[bot] <github-actions[bot]@users.noreply.github.com>'

          if ! git commit -m "$commit_msg"; then
            echo "âŒ æäº¤å¤±è´¥"
            exit 1
          fi

          echo "âœ… æäº¤æˆåŠŸ"

          echo ""
          echo "ğŸ“¤ æ¨é€åˆ°ä¸»ä»“åº“..."
          if ! git push origin main; then
            echo "âŒ æ¨é€å¤±è´¥"
            exit 1
          fi

          echo "âœ… ä¸»ä»“åº“åŒæ­¥å®Œæˆ"

      # ============================================================
      # é˜¶æ®µ 5: è¾“å‡ºæ‘˜è¦
      # ============================================================

      - name: Build job summary
        if: always()
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" >> $GITHUB_STEP_SUMMARY
          echo "# ğŸ“¦ AUR åŒ…æ›´æ–°æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## æ‰§è¡Œç»“æœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… æˆåŠŸæ›´æ–°: \`${{ steps.build_aur.outputs.updated_count }}\` ä¸ªåŒ…" >> $GITHUB_STEP_SUMMARY
          echo "- âŒ å¤±è´¥: \`${{ steps.build_aur.outputs.failed_count }}\` ä¸ªåŒ…" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ”„ æ˜¯å¦æœ‰æ›´æ–°: \`${{ steps.build_aur.outputs.has_updates }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" >> $GITHUB_STEP_SUMMARY
