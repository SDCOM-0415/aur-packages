name: Update AUR Packages

on:
  schedule:
    - cron: '0 18 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          submodules: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install dependencies
        run: |
          pacman -Syu --noconfirm --needed
          pacman -S --noconfirm --needed base-devel git openssh curl

      - name: Setup Python
        uses: astral-sh/setup-uv@v7
        with:
          python-version: '3.13'
          enable-cache: true
          cache-dependency-glob: 'scripts/pyproject.toml'

      - name: Install Python dependencies
        working-directory: scripts
        run: uv sync

      - name: Run update script
        working-directory: scripts
        run: uv run main.py --all

      - name: Setup build user and SSH
        run: |
          useradd -m -G wheel builduser
          echo "builduser ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/builduser

          sudo -u builduser mkdir -p /home/builduser/.ssh
          echo "${{ secrets.AUR_SSH_PRIVATE_KEY }}" | sudo -u builduser tee /home/builduser/.ssh/id_ed25519 > /dev/null
          sudo -u builduser chmod 600 /home/builduser/.ssh/id_ed25519
          sudo -u builduser ssh-keyscan aur.archlinux.org >> /home/builduser/.ssh/known_hosts

      - name: Build and push to AUR
        run: |
          set -e

          for pkg in packages/*; do
            [ -f "$pkg/PKGBUILD" ] || continue

            pkgname=$(basename "$pkg")
            echo "Processing $pkgname..."

            # 在子模块目录中操作
            cd "$pkg"

            # 生成 .SRCINFO
            sudo -u builduser makepkg --printsrcinfo > .SRCINFO

            # 构建测试
            sudo -u builduser makepkg -fs --noconfirm

            # 提交修改到子模块
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git config user.name "github-actions[bot]"
            git add -A

            if ! git diff --staged --quiet; then
              version=$(grep '^pkgver=' PKGBUILD | cut -d= -f2 | tr -d '"'"'')
              git commit -m "Update to $version"
              git push origin HEAD
              echo "Updated $pkgname to $version"
            fi

            cd -
          done

      - name: Update submodule references and push to main repo
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # 添加子模块的最新引用
          git add packages/

          # 如果有变更，提交并推送
          if ! git diff --cached --quiet; then
            git commit -m "chore: update AUR submodules"
            git push
          fi
